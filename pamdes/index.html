<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">

    <title>St Pamdes</title>
    <meta content="" name="description">
    <meta content="" name="keywords">

    <!-- Favicons -->
    <link href="assets/img/logo-2.png" rel="icon">
    <link href="assets/img/apple-touch-icon.png" rel="apple-touch-icon">

    <!-- Google Fonts -->
    <link
        href="https://fonts.googleapis.com/css?family=Open+Sans:300,300i,400,400i,600,600i,700,700i|Montserrat:300,300i,400,400i,500,500i,600,600i,700,700i|Poppins:300,300i,400,400i,500,500i,600,600i,700,700i"
        rel="stylesheet">

    <!-- Vendor CSS Files -->
    <link href="assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="assets/vendor/icofont/icofont.min.css" rel="stylesheet">
    <link href="assets/vendor/boxicons/css/boxicons.min.css" rel="stylesheet">
    <link href="assets/vendor/venobox/venobox.css" rel="stylesheet">
    <link href="assets/vendor/remixicon/remixicon.css" rel="stylesheet">
    <link href="assets/vendor/owl.carousel/assets/owl.carousel.min.css" rel="stylesheet">
    <link href="assets/vendor/aos/aos.css" rel="stylesheet">

    <!-- Template Main CSS File -->
    <link href="assets/css/style.css" rel="stylesheet">

    <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.10/css/select2.min.css" rel="stylesheet" />

</head>

<body>
    <!-- ======= Header ======= -->
    <header id="header" class="fixed-top d-flex align-items-center">
        <div class="container d-flex align-items-center">

            <div class="logo mr-auto">
                <h1 class="text-light">

                    <a href="#hero">
                        <img src="assets/img/logo.png" alt="" srcset="">
                        <span>St Pamdes</span>
                    </a>
                </h1>
            </div>

            <nav class="nav-menu d-none d-lg-block">
                <ul>
                    <li><a href="#hero">Home</a></li>
                    <li><a href="#form">Catat Pemakaian</a></li>
                </ul>
            </nav><!-- .nav-menu -->

        </div>
    </header><!-- End Header -->

    <!-- ======= Hero Section ======= -->
    <section id="hero">

        <div class="container">
            <div class="row">
                <div class="col-lg-7 pt-5 pt-lg-0 order-2 order-lg-1 d-flex align-items-center">
                    <div data-aos="zoom-out">
                        <h1>Selamat Datang di <br> <span>St Pamdes</span></h1>
                        <h2>Untuk input data pemakaian air, silahkan klik tombol catat pemakaian</h2>
                        <div class="text-center text-lg-left">
                            <a href="#form" class="btn-get-started">Catat Pemakaian</a>
                        </div>
                    </div>
                </div>
                <div class="col-lg-5 order-1 order-lg-2 hero-img" data-aos="zoom-out" data-aos-delay="300">
                    <img src="/pamdes/assets/img/hero-img.png" class="img-fluid animated" alt="">
                </div>
            </div>
        </div>

        <svg class="hero-waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
            viewBox="0 24 150 28 " preserveAspectRatio="none">
            <defs>
                <path id="wave-path" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z">
            </defs>
            <g class="wave1">
                <use xlink:href="#wave-path" x="50" y="3" fill="rgba(255,255,255, .1)">
            </g>
            <g class="wave2">
                <use xlink:href="#wave-path" x="50" y="0" fill="rgba(255,255,255, .2)">
            </g>
            <g class="wave3">
                <use xlink:href="#wave-path" x="50" y="9" fill="#fff">
            </g>
        </svg>

    </section><!-- End Hero -->

    <main id="form">
        <section id="formulir" class="faq section-bg mt-5">
            <div class="container">
                <div class="section-title mt-5" data-aos="fade-up">
                    <h2>Pemakaian</h2>
                    <p>Catat Pemakaian</p>
                    <span>
                        Silahkan isikan data kemudian klik tombol
                        <b>Kirim Data</b>!
                    </span>
                </div>


                <div class="row">
                    <div class="col-lg-12" data-aos="fade-left" data-aos-delay="200">

                        <form name="submit-to-google-sheet" role="form" class="php-email-form">
                            <!-- Identitas Pribadi -->
                            <div class="faq-list">
                                <ul>
                                    <li data-aos="fade-up" id="peserta">
                                        <i class="bx bx-notepad icon-help"></i> <a data-toggle="collapse"
                                            class="collapse" href="#">Pemakaian Air</a>
                                        <div id="pemakaian-air" class="collapse show" data-parent=".faq-list">
                                            <div class="form-row mt-4">
                                                <div class="col-md-6 form-group">
                                                    <label for="bulan_tahun">Bulan Tahun</label>
                                                    <select name="bulan_tahun" class="form-control required"
                                                        id="bulan_tahun">
                                                        <option value="">-- Pilih Data --</option>
                                                    </select>
                                                    <small class="text-danger" id="bulan_tahun-invalid-message"></small>
                                                </div>
                                                <div class="col-md-6 form-group">
                                                    <label for="kode_pelanggan">Kode Pelanggan</label>
                                                    <select name="kode_pelanggan" class="form-control required"
                                                        id="kode_pelanggan">
                                                        <option value="">-- Pilih Data --</option>
                                                    </select>
                                                    <small class="text-danger"
                                                        id="kode_pelanggan-invalid-message"></small>
                                                </div>
                                            </div>

                                            <div class="form-row">
                                                <div class="col-md-6 form-group">
                                                    <label for="pemakaian_sebelumnya">Pemakaian Air Bulan Sebelumnya
                                                        (M<sup>3</sup>) <small><i>(opsional)</i></small>
                                                    </label>
                                                    <input type="text" name="pemakaian_sebelumnya"
                                                        class="form-control autonumeric" id="pemakaian_sebelumnya" />
                                                    <small class="text-danger"
                                                        id="pemakaian_sebelumnya-invalid-message"></small>
                                                </div>
                                                <div class="col-md-6 form-group">
                                                    <label for="pemakaian_saat_ini">Pemakaian Air Saat Ini
                                                        (M<sup>3</sup>)
                                                    </label>
                                                    <input type="text" name="pemakaian_saat_ini"
                                                        class="form-control required autonumeric"
                                                        id="pemakaian_saat_ini" />
                                                    <small class="text-danger"
                                                        id="pemakaian_saat_ini-invalid-message"></small>
                                                </div>
                                            </div>

                                        </div>
                                    </li>
                                </ul>
                            </div>

                            <div class="alert alert-success alert-dismissible d-none fade show success-alert mt-2 pr-4 pl-4"
                                role="alert">
                                <h4 class="alert-heading">Success !</h4>
                                <p>Terimakasih data anda berhasil dikirim.</p>
                            </div>

                            <div class="alert alert-danger alert-dismissible d-none fade show danger-alert mt-2"
                                role="alert">
                                <strong><i class="icofont-ui-close"></i> Error !</strong> Data anda gagal dikirim.
                                <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                                    <span aria-hidden="true">&times;</span>
                                </button>
                            </div>

                            <!-- Button Submit -->
                            <div class="text-center mt-4">
                                <button class="btn btn-success btn-lg btn-block btn-kirim" id="btn-kirim"
                                    name="submit">Kirim
                                    Data</button>

                                <button class="btn btn-primary btn-lg btn-block btn-loading d-none" type="button"
                                    disabled>
                                    <span class="spinner-border spinner-border-lg" role="status"
                                        aria-hidden="true"></span>
                                    Harap tunggu...
                                </button>
                            </div>
                        </form>

                    </div>
                </div>
            </div>
        </section>

    </main><!-- End #main -->

    <!-- ======= Footer ======= -->
    <footer id="footer">
        <div class="container">
            <div class="copyright">
                &copy; Copyright <strong><span>St Pamdes</span></strong>. 2023
            </div>
            <div class="credits">
                Developed by <a href="https://www.instagram.com/qkoh_st/" target="_black">Qkoh St</a>
            </div>
        </div>
    </footer><!-- End Footer -->

    <a href="#" class="back-to-top"><i class="icofont-simple-up"></i></a>

    <!-- Vendor JS Files -->
    <script src="assets/vendor/jquery/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.10/js/select2.min.js"></script>
    <script src="assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
    <script src="assets/vendor/jquery.easing/jquery.easing.min.js"></script>
    <script src="assets/vendor/php-email-form/validate.js"></script>
    <script src="assets/vendor/venobox/venobox.min.js"></script>
    <script src="assets/vendor/waypoints/jquery.waypoints.min.js"></script>
    <script src="assets/vendor/counterup/counterup.min.js"></script>
    <script src="assets/vendor/owl.carousel/owl.carousel.min.js"></script>
    <script src="assets/vendor/aos/aos.js"></script>

    <!-- Template Main JS File -->
    <script src="assets/js/main.js"></script>

    <script src="assets/vendor/autoNumeric/autoNumeric.js"></script>

    <script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>

        $(document).ready(function () {
            $('select').select2({
                width: '100%',
                placeholder: "-- Pilih Data --",
            });

            $('.autonumeric').each(function () {
                $(this).autoNumeric('init', {
                    mDec: 0,
                    aSep: '.',
                    aDec: ',',
                    vMin: '0'
                    // aPad: false
                });
            });

            // render data pelanggan
            $.ajax({
                type: "GET",
                dataType: "json",
                url: "https://qkohst.github.io/pamdes/pelanggan.json",
                success: function (result) {
                    // console.log(result);
                    let option = '<option value="">-- Pilih Data --</option>';
                    result.data.forEach(item => {
                        option += '<option value="' + item.kode_pelanggan + '">' + item.nama_pelanggan + '</option>';
                    });
                    $('#kode_pelanggan').html(option);
                }
            });

            let option_tahun = getOptionBulanTahun();
            var select = $('#bulan_tahun');
            for (var key in option_tahun) {
                var option = $('<option>', {
                    value: key,
                    text: option_tahun[key]
                });
                select.append(option);
            }
        });

        function getOptionBulanTahun() {
            var tahun = 2023;
            var batas = new Date().getFullYear();
            var bulan_sekarang = new Date().getMonth() + 1;
            var data = {};

            for (var i = batas; i >= tahun; i--) {
                for (var j = 12; j >= 1; j--) {
                    if (i == batas) {
                        if (j <= bulan_sekarang) {
                            data[i + '-' + ('0' + j).slice(-2)] = tglIndo(i + '-' + ('0' + j).slice(-2));
                        }
                    } else {
                        data[i + '-' + ('0' + j).slice(-2)] = tglIndo(i + '-' + ('0' + j).slice(-2));
                    }
                }
            }

            return data;
        }

        // Fungsi untuk mengubah format tanggal menjadi format Indonesia
        function tglIndo(tanggal) {
            var bulan = [
                "Januari", "Februari", "Maret", "April", "Mei", "Juni",
                "Juli", "Agustus", "September", "Oktober", "November", "Desember"
            ];

            var pecahkan = tanggal.split('-');
            return bulan[parseInt(pecahkan[1]) - 1] + ' ' + pecahkan[0];
        }

        $("#btn-kirim").click(function () {
            let isValid = checkValidateForm();
            if (isValid == true) {
                Swal.fire({
                    title: 'Apakah anda yakin ?',
                    text: "Data yang sudah dikirim tidak dapat diedit!",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#3085d6',
                    cancelButtonColor: '#d33',
                    confirmButtonText: 'OK',
                    cancelButtonText: 'Batal'
                }).then((result) => {
                    if (result.isConfirmed) {
                        submitForm();
                    }
                })
            } else {
                autoFocusFormInvalid();
            }
        });

        function checkValidateForm() {
            let result = true;

            $('.required').each(function () {
                let val = $(this).val();
                let name = $(this).attr('name');
                if (val == '' || val == 0) {
                    let message_name = name.replaceAll("_", " ")
                    $('#' + name + '-invalid-message').text(message_name + ' harus diisi');
                    result = false;
                }
            });

            let pemakaian_sebelumnya = $('#pemakaian_sebelumnya').autoNumeric('get');
            let pemakaian_saat_ini = $('#pemakaian_saat_ini').autoNumeric('get');
            if (pemakaian_saat_ini <= pemakaian_sebelumnya) {
                $('#pemakaian_saat_ini-invalid-message').text('Pemakaian saat ini harus lebih besar dari pemakaian sebelumnya');
                $('#pemakaian_saat_ini').focus();
                result = false;
            }

            return result;
        }

        function autoFocusFormInvalid() {
            $('.required').each(function () {
                let val = $(this).val();
                if (val == '' || val == 0) {
                    $(this).focus();
                    return false;
                }
            });
        }

        function submitForm() {
            const scriptURL = 'https://script.google.com/macros/s/AKfycbxBbc1FqMFV6AvMPWyK3z8FHAtnAknSxxGASIKTZwf2U0DI7aRJTTajMcjOzCIq0vtP/exec'
            const form = document.forms['submit-to-google-sheet']
            const btnKirim = document.querySelector('.btn-kirim');
            const btnLoading = document.querySelector('.btn-loading');
            const successAlert = document.querySelector('.success-alert');
            const errorAlert = document.querySelector('.danger-alert');

            // ketika tombol submit diklik
            // tampilkan tombol loading, hilangkan tombol kirim
            btnLoading.classList.toggle('d-none');
            btnKirim.classList.toggle('d-none');

            fetch(scriptURL, {
                method: 'POST',
                body: new FormData(form),
                mode: 'no-cors',
            })
                .then((response) => {
                    // tampilkan tombol kirim, hilangkan tombol loading
                    btnLoading.classList.toggle('d-none');
                    // tampilkan alert
                    Swal.fire(
                        'Berhasil',
                        'Data berhasil dikirim',
                        'success'
                    )
                    // successAlert.classList.toggle('d-none');
                    btnKirim.classList.toggle('d-none');
                    // reset formnya
                    resetForm();
                    console.log('Success!', response);
                })
                .catch((error) => {
                    // tampilkan tombol kirim, hilangkan tombol loading
                    btnLoading.classList.toggle('d-none');
                    btnKirim.classList.toggle('d-none');
                    // tampilkan alert
                    Swal.fire(
                        'Gagal',
                        'Data gagal dikirim',
                        'error'
                    )
                    errorAlert.classList.toggle('d-none');
                    console.error('Error!', error.message);
                });
        }

        function resetForm() {
            const form = document.forms['submit-to-google-sheet']
            form.reset();
            $('.form-control').val('');
            $('.form-control').trigger('change.select2');
        }

        // hapus invalid message ketika form diisi 
        $(document).on('keyup', '.required', function (e) {
            e.preventDefault();
            let name = $(this).attr('name');
            $('#' + name + '-invalid-message').text('');
        });

        $(document).on('select2:select', '.required', function (e) {
            e.preventDefault();
            let name = $(this).attr('name');
            $('#' + name + '-invalid-message').text('');
        });

    </script>

</body>

</html>